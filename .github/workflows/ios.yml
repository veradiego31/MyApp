name: iOS starter workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build and Test default scheme using any available iPhone simulator
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'
      - name: Set Default Scheme
        run: |
          scheme_list=$(xcodebuild -list -json | tr -d "\n")
          default=$(echo $scheme_list | ruby -e "require 'json'; puts JSON.parse(STDIN.gets)['project']['targets'][0]")
          echo $default | cat >default
          echo Using default scheme: $default
      - name: Resolve simulator destination
        run: |
          selected=$(xcrun simctl list devices available -j | ruby -rjson -e '
            data = JSON.parse(STDIN.read)
            candidates = []
            data.fetch("devices", {}).each_value do |devices|
              devices.each do |device|
                next unless device["isAvailable"]
                name = device["name"].to_s
                next unless name.start_with?("iPhone")
                candidates << [name, device["udid"]]
              end
            end

            preferred = ["iPhone 16", "iPhone 15", "iPhone 14"]
            chosen = nil
            preferred.each do |name|
              chosen = candidates.find { |candidate| candidate[0] == name }
              break if chosen
            end
            chosen ||= candidates.first

            puts "#{chosen[0]}|#{chosen[1]}" if chosen
          ')

          if [ -z "$selected" ]; then
            echo "No available iPhone simulator found on this runner."
            echo "Installed runtimes:"
            xcrun simctl list runtimes
            exit 1
          fi

          device_name=$(echo "$selected" | cut -d'|' -f1)
          device_udid=$(echo "$selected" | cut -d'|' -f2)

          echo "Selected simulator: $device_name ($device_udid)"
          xcrun simctl boot "$device_udid" || true
          xcrun simctl bootstatus "$device_udid" -b

          destination="platform=iOS Simulator,id=$device_udid"
          echo "Using destination: $destination"
          echo "destination=$destination" >> "$GITHUB_ENV"
      - name: Build
        env:
          scheme: ${{ 'default' }}
        run: |
          if [ $scheme = default ]; then scheme=$(cat default); fi
          if [ "`ls -A | grep -i \\.xcworkspace\$`" ]; then filetype_parameter="workspace" && file_to_build="`ls -A | grep -i \\.xcworkspace\$`"; else filetype_parameter="project" && file_to_build="`ls -A | grep -i \\.xcodeproj\$`"; fi
          file_to_build=`echo $file_to_build | awk '{$1=$1;print}'`
          xcodebuild build-for-testing -scheme "$scheme" -"$filetype_parameter" "$file_to_build" -destination "$destination" -destination-timeout 180
      - name: Test
        env:
          scheme: ${{ 'default' }}
        run: |
          if [ $scheme = default ]; then scheme=$(cat default); fi
          if [ "`ls -A | grep -i \\.xcworkspace\$`" ]; then filetype_parameter="workspace" && file_to_build="`ls -A | grep -i \\.xcworkspace\$`"; else filetype_parameter="project" && file_to_build="`ls -A | grep -i \\.xcodeproj\$`"; fi
          file_to_build=`echo $file_to_build | awk '{$1=$1;print}'`
          xcodebuild test-without-building -scheme "$scheme" -"$filetype_parameter" "$file_to_build" -destination "$destination" -destination-timeout 180
